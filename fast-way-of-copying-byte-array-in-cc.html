<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Fast way of copying byte array in C/C++ (With measurements) - sergem personal public notebook</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/fast-way-of-copying-byte-array-in-cc.html">

        <meta name="author" content="SergeM" />
        <meta name="keywords" content="c++,algorithm performance,video processing" />
        <meta name="description" content="I have the following code for copying several buffers from one object to another: :::: // Copy several buffers (images) for( int i = 0; i" />

        <meta property="og:site_name" content="sergem personal public notebook" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Fast way of copying byte array in C/C++ (With measurements)"/>
        <meta property="og:url" content="/fast-way-of-copying-byte-array-in-cc.html"/>
        <meta property="og:description" content="I have the following code for copying several buffers from one object to another: :::: // Copy several buffers (images) for( int i = 0; i"/>
        <meta property="article:published_time" content="2013-10-15" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="c++" />
            <meta property="article:tag" content="algorithm performance" />
            <meta property="article:tag" content="video processing" />
            <meta property="article:author" content="SergeM" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
sergem personal public notebook            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="/category/misc.html">Misc</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/fast-way-of-copying-byte-array-in-cc.html"
                       rel="bookmark"
                       title="Permalink to Fast way of copying byte array in C/C++ (With measurements)">
                        Fast way of copying byte array in C/C++ (With measurements)
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-10-15T15:22:00+02:00"> Tue 15 October 2013</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/c.html">c++</a>
        /
	<a href="/tag/algorithm-performance.html">algorithm performance</a>
        /
	<a href="/tag/video-processing.html">video processing</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <div dir="ltr" style="text-align: left;" trbidi="on">I have the following code for copying several buffers from one object to another:

    ::::
    // Copy several buffers (images)
    for( int i = 0; i < MIN( conf_.size(), src.conf_.size() ); ++ i )
    {
       // Copy one image per pixel
       for( int j = 0; j < MIN( sizeOfBuffer_, src.sizeOfBuffer_ ); ++ j )
       {
          conf_[i][j] = src.conf_[i][j];
       }
    }



Array conf_ is defined as follows: 

    ::::
    std::vector<BYTE*> conf_;

BYTE is unsigned char. That code is written with no doubt about software performance. It just works. When I do so I hope compiler make it better for me.
This fragment takes about **45 ms** for copying of 2 images with ( 1980x1080 pixels ) x 3 planes = 6.2 MPixels.
I use Microsoft Visual Studio 2008 compiler on Intel Core i7 950 @ 3.07 GHz. The code is built for x64 platform. Disabled compiler option for buffer security check (GS-) and debug information has no effect on the productivity.

Slightly better solution:

    ::::
    // Copy several buffers (images)
    for( int i = 0; i < MIN( conf_.size(), src.conf_.size() ); ++ i )
    {

    ::::
       int sizeOfArray = MIN( sizeOfBuffer_, src.sizeOfBuffer_ );

       // Copy one image per pixel
       for( int j = 0; j <&nbsp;sizeOfArray; ++ j )

    ::::
       {
          conf_[i][j] = src.conf_[i][j];
       }
    }
It takes about **35 ms **per full copy. 

Much better solution:




    ::::
    // Copy several buffers (images)
    for( int i = 0; i < MIN( conf_.size(), src.conf_.size() ); ++ i )
    {
       BYTE * arrDst = conf_[i];
       BYTE * arrSrc = src.conf_[i];
       int sizeOfArray = MIN( sizeOfBuffer_, src.sizeOfBuffer_ );

       // Copy one image per pixel
       for( int j = 0; j < sizeOfArray; ++ j )
       {
          arrDst[j] = arrSrc[j];
       }
    }

    ::::


    ::::


Everything is the same except for using additional temporary variable. This version runs for** 8 ms**. 
UPD: Intel Compiler 2011 demonstrates **2 ms**&nbsp;latency for this code.

And even better solution for Visual Studio:

    ::::
    // Copy several buffers (images)
    for( int i = 0; i < MIN( conf_.size(), src.conf_.size() ); ++ i )
    {
       BYTE * arrDst = conf_[i];
       BYTE * arrSrc = src.conf_[i];
       int sizeOfArray = MIN( sizeOfBuffer_, src.sizeOfBuffer_ );

       // Copy one image per pixel
       std::copy( arrSrc, arrSrc + sizeOfArray, arrDst );
    }
It uses **copy **function from standard C++ library. Time of this version is **2 ms**.   
UPD: Intel Compiler 2011 demonstrates&nbsp;**2 ms**&nbsp;latency for this code too, but it seems that for multiple runs the last version is slightly slower than previous one for ICC. My previous time measuremets have integer precision. So for 50 frames ICC+last-version got&nbsp;**141 ms** and ICC+previous-version got&nbsp;**112 ms. **That is strange.

On Intel Compiler memcpy and std::copy give nearly the same results.

</div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="/podcasts.html">
                            podcasts
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/fix-google-search-suggestions-in-firefox-in-linux-mint.html">
                            How to fix google search suggestions in Firefox in Linux Mint
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/git-apply-patch-from-another-repository.html">
                            git apply patch from another repository
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/terminal-setup-in-linux-mint.html">
                            terminal setup in linux mint
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/fix-boot-record-after-moving-linux-mint.html">
                            Fix boot record after moving linux mint partitions to another disk
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/mount-yandex-webdav-on-local-dir.html">
                            Mount yandex webdav on local dir
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/how-torch-stores-images.html">
                            how torch stores images
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/installing-torch-for-miniconda.html">
                            Installing torch for miniconda
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/compile-dlib-for-miniconda.html">
                            compile dlib for miniconda
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/mount-windows-shares-in-linux.html">
                            Mount windows shares in linux
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/deep-learning.html">
                            deep learning
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/autocomplete-from-history-in-terminal.html">
                            autocomplete from history in terminal (in linux mint)
                        </a>
                    </li>
                </ul>
            </li>

            <li class="list-group-item"><a href="/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                <ul class="list-group" id="categories">
                    <li class="list-group-item">
                        <a href="/category/misc.html">
                            <i class="fa fa-folder-open fa-lg"></i> misc
                        </a>
                    </li>
                </ul>
            </li>



    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 sergem
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40853494-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>