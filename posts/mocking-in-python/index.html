<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Mocking in Python | sergem's personal public notebook</title><meta name=keywords content="python,testing,unittests"><meta name=description content="Let&rsquo;s consider how python standard unittest module suppose to use mocks.
Assume we want to test a method that creates and uses objects of other classes:
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # content of module.py # classes that we want to mock class ClassName1: pass class ClassName2: pass # class that we want to test class ProductionClass: def foo(self, parameter1, parameter2): object1 = module."><meta name=author content="SergeM"><link rel=canonical href=https://serge-m.github.io/posts/mocking-in-python/><link href=/assets/css/stylesheet.min.6d98a2276d0cb41ef459267b3ff3ef02df70a8f16b70bbc52b20568702bc90cf.css integrity="sha256-bZiiJ20MtB70WSZ7P/PvAt9wqPFrcLvFKyBWhwK8kM8=" rel="preload stylesheet" as=style><link rel=icon href=https://serge-m.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://serge-m.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://serge-m.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://serge-m.github.io/apple-touch-icon.png><link rel=mask-icon href=https://serge-m.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.97.3"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-40853494-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="Mocking in Python"><meta property="og:description" content="Let&rsquo;s consider how python standard unittest module suppose to use mocks.
Assume we want to test a method that creates and uses objects of other classes:
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # content of module.py # classes that we want to mock class ClassName1: pass class ClassName2: pass # class that we want to test class ProductionClass: def foo(self, parameter1, parameter2): object1 = module."><meta property="og:type" content="article"><meta property="og:url" content="https://serge-m.github.io/posts/mocking-in-python/"><meta property="og:image" content="https://serge-m.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-06T00:01:00+00:00"><meta property="article:modified_time" content="2017-03-06T00:01:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://serge-m.github.io/papermod-cover.png"><meta name=twitter:title content="Mocking in Python"><meta name=twitter:description content="Let&rsquo;s consider how python standard unittest module suppose to use mocks.
Assume we want to test a method that creates and uses objects of other classes:
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # content of module.py # classes that we want to mock class ClassName1: pass class ClassName2: pass # class that we want to test class ProductionClass: def foo(self, parameter1, parameter2): object1 = module."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://serge-m.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Mocking in Python","item":"https://serge-m.github.io/posts/mocking-in-python/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Mocking in Python","name":"Mocking in Python","description":"Let\u0026rsquo;s consider how python standard unittest module suppose to use mocks.\nAssume we want to test a method that creates and uses objects of other classes:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # content of module.py # classes that we want to mock class ClassName1: pass class ClassName2: pass # class that we want to test class ProductionClass: def foo(self, parameter1, parameter2): object1 = module.","keywords":["python","testing","unittests"],"articleBody":"Let’s consider how python standard unittest module suppose to use mocks.\nAssume we want to test a method that creates and uses objects of other classes:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # content of module.py # classes that we want to mock class ClassName1: pass class ClassName2: pass # class that we want to test class ProductionClass: def foo(self, parameter1, parameter2): object1 = module.ClassName1(\"some_initial_parameter1\") intermediate_result = object1.run(parameter1) object2 = module.ClassName2(\"some_initial_parameter2\") final_result = object2.run(intermediate_result, parameter2) return final_result   Here is how we can test object creation (Snippet is taken from official documentation):\n1 2 3 4 5 6 7 8 9 10 11 12  from unittest.mock import patch @patch('module.ClassName2') @patch('module.ClassName1') def test(MockClass1, MockClass2): module.ClassName1() module.ClassName2() assert MockClass1 is module.ClassName1 assert MockClass2 is module.ClassName2 assert MockClass1.called assert MockClass2.called test()   I would say that in our case we need also to check that each object (object1 and object2) were instanciated and called with correct parameters. Then we can use assert_called_once_with like this (example from official documentation):\n1 2 3 4 5  with patch.object(ProductionClass, 'method', return_value=None) as mock_method: thing = ProductionClass() thing.method(1, 2, 3) mock_method.assert_called_once_with(1, 2, 3)   Combining things together:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  mocked_intermediate_result = \"some-intermediate-result\" mocked_final_result = \"some-final-result\" from unittest.mock import patch @patch('module.ClassName2') @patch('module.ClassName1') def test_foo(MockClass1, MockClass2): MockClass1.return_value.run.return_value = mocked_intermediate_result MockClass2.return_value.run.return_value = mocked_final_result actual_result = module.ProductionClass().foo(\"parameter1\", \"parameter2\") assert actual_result == mocked_final_result MockClass1.assert_called_once_with(\"some_initial_parameter1\") MockClass1.return_value.run.assert_called_once_with(\"parameter1\") MockClass2.assert_called_once_with(\"some_initial_parameter2\") MockClass2.return_value.run.assert_called_once_with(mocked_intermediate_result, \"parameter2\")   Seems good but a little bit too verbose. Assertions on calls could be eliminated. I would like to do it like in Java with Mockito:\n1  when(mockedObject.foo(\"parameter\")).thenReturn(\"mocked-result\");   That means you don’t need to verify intermediate calls. If they fail, the consequent calls fail as well.\nThe test would look like this:\n1 2 3 4 5 6 7 8 9  @patch('module.ClassName2') @patch('module.ClassName1') def test_foo(MockClass1, MockClass2): when(MockClass1).__call__(\"some_initial_parameter1\").then_when().run(\"parameter1\").then_return(mocked_intermediate_result) when(MockClass2).__call__(\"some_initial_parameter2\").then_when().run(mocked_intermediate_result, \"parameter2\").then_return(mocked_final_result) actual_result = module.ProductionClass().foo(\"parameter1\", \"parameter2\") assert actual_result == mocked_final_result   You don’t need calls assertions in the end. If for example object1.run(parameter1) returns something else, then condition of the second mock object is not met and the test fails.\nQuestion: is there a way to achieve that?\nThere is a port of Mockito to Python: mockito-python There you can do virtually the same as in Java:\nfrom mockito import when, mock, unstub when(os.path).exists('/foo').thenReturn(True) # or: import requests # the famous library # you actually want to return a Response-like obj, we'll fake it response = mock({'status_code': 200, 'text': 'Ok'}) when(requests).get(...).thenReturn(response) # use it requests.get('http://google.com/') # clean up unstub() But:\n  clean up is required\n  the module seems not integrating standard unittest’s mocks . Maybe I am wrong, more investigation is required. I want to use mock.patch and have when-thenReturn construction working for it.\n  Similar articles  Python Mocking 101: Fake It Before You Make It Using the Python mock library to fake regular functions during tests  Mocking requests in python There is a library requests-mock that helps testing network interactions.\nInstallation is easy: pip install requests_mock.\nUsage example Lets imagine you have a function get_data that queries an external API. We want to check that the function throws an exception if page is not found (http code 404).\n1 2 3 4 5 6 7 8 9  import pytest import requests_mock def test_function_throws_an_exception_if_page_not_found(): with requests_mock.Mocker() as m: m.post(url, text=error_text, status_code=404) with pytest.raises(Exception): get_data(url)   m.post mocks requests for the predefined url and returns status_code=404 and some text message. One can also specify returned JSON data.\nHow to avoid mocking Python is very too flexible with respect to types. Sometimes it plays agains the developers. If interface of the mocked class A changes you don’t notice that tests for a dependent class B are failing if you mock A in test_B.\nPossible way to avoid it is to pass a factory to the dependent class.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  class ClassName1: pass class ClassName2: pass class ClassFactory: def create_instance_class1(self, parameter): return ClassName1(parameter) def create_instance_class2(self, parameter): return ClassName2(parameter) # class that we want to test class ProductionClassWithFactory: def __init__(self, factory): self.factory = factory def foo(self, parameter1, parameter2): object1 = self.factory.create_instance_class1(\"some_initial_parameter1\") intermediate_result = object1.run(parameter1) object2 = self.factory.create_instance_class2(\"some_initial_parameter2\") final_result = object2.run(intermediate_result, parameter2) return final_result   Let’s test:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  def test_foo(): mocked_obj1 = MagicMock() mocked_obj1.run.return_value = \"result1\" mocked_obj2 = MagicMock() mocked_obj2.run.return_value = \"result2\" mocked_factory = MagicMock() mocked_factory.create_instance_class1.return_value = mocked_obj1 mocked_factory.create_instance_class2.return_value = mocked_obj2 actual_result = ProductionClassWithFactory(mocked_factory).foo(\"parameter1\", \"parameter2\") # check final result: assert actual_result == \"result2\" # check calls arguments mocked_factory.create_instance_class1.assert_called_once_with(\"some_initial_parameter1\") mocked_factory.create_instance_class2.assert_called_once_with(\"some_initial_parameter2\") mocked_obj1.run.assert_called_once_with(\"parameter1\") mocked_obj2.run.assert_called_once_with(\"result1\", \"parameter2\")   Also you need to test the factory now. And it will require class monkey-patching. But in this case you put all monkey patching in one place.\nMatching attributes for mocks Keep in mind that standard mocks don’t care about non-existent atttributes. I use\n1  @patch('module.ClassName1', autospec=True)   instead of\n1  @patch('module.ClassName1')   That adds automatic checking of non-existent attributes and catches more errors. Let’s see where autospec=True can save your life.\n1 2 3 4 5 6 7 8  class A: def foo(): return \"foo\" class B: def bar(): return \"bar\" + A().foo()   here comes a test:\n1 2 3 4  @mock.patch('module.A') def test_bar(MockedA): MockedA.return_value.foo.return_value = \"mocked-foo\" assert B().bar() == \"bar\" + \"mocked-foo\"   At some point you decide to change class A. New version:\n1 2 3  class A: def oops(): return \"oops\"   You change tests for A but you can forget to fix B and tests for B. test_bar will still work because mocked A still have foo. Probably you can catch that error on integration tests level, but it is better to “fail fast”.\nIf you use @mock.patch('module.A', autospec=True), then you get an error (about non-existent attribute) after you change A on\n1  MockedA.return_value.foo.return_value = \"mocked-foo\"   I think autospec=True has to be default behaviour of patch.\nSee also Mocking Objects in Python section “Danger: mocking non-existent attributes”\nAlternative mocking libraries Flexmock – extended/rebuilt clone of mocking library from Ruby. Abandoned project (last update in github in 2016).\nInteresting syntax. Probably cleaner mocking sometimes. Example from docs for overriding new instances of a class:\n1 2 3 4 5 6 7 8 9 10 11  # flexmock flexmock(some_module.SomeClass).new_instances(some_other_object) assertEqual(some_other_object, some_module.SomeClass()) # ....... # Mock with mock.patch('somemodule.Someclass') as MockClass: MockClass.return_value = some_other_object assert some_other_object == some_module.SomeClass()   // Will it really work?\nMocking os.environ @mock.patch.dict(os.environ, {'YOUR_VARIABLE': 'MOCKED_VALUE'}) def test_funciton(): function_using_os_environment() See also about testing in python  Run docker as pytest fixture Testing json responses in Flask REST apps with pytest Refactoring python code. Extracting variables and other. Alex Marandon. Python Mock Gotchas José R.C. Cruz. Using Mocks in Python. May 22, 2014 https://semaphoreci.com/community/tutorials/testing-python-requests-with-betamax  More about mocking and testing  Martin Fowler. Mocks Aren’t Stubs  ","wordCount":"1133","inLanguage":"en","datePublished":"2017-03-06T00:01:00Z","dateModified":"2017-03-06T00:01:00Z","author":{"@type":"Person","name":"SergeM"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://serge-m.github.io/posts/mocking-in-python/"},"publisher":{"@type":"Organization","name":"sergem's personal public notebook","logo":{"@type":"ImageObject","url":"https://serge-m.github.io/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://serge-m.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://serge-m.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://serge-m.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://serge-m.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://serge-m.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://serge-m.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://serge-m.github.io/posts/>Posts</a></div><h1 class=post-title>Mocking in Python</h1><div class=post-meta>March 6, 2017&nbsp;·&nbsp;SergeM</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#similar-articles aria-label="Similar articles">Similar articles</a></li><li><a href=#mocking-requests-in-python aria-label="Mocking requests in python">Mocking requests in python</a><ul><li><a href=#usage-example aria-label="Usage example">Usage example</a></li></ul></li><li><a href=#how-to-avoid-mocking aria-label="How to avoid mocking">How to avoid mocking</a></li><li><a href=#matching-attributes-for-mocks aria-label="Matching attributes for mocks">Matching attributes for mocks</a></li><li><a href=#alternative-mocking-libraries aria-label="Alternative mocking libraries">Alternative mocking libraries</a></li><li><a href=#mocking-osenviron aria-label="Mocking os.environ">Mocking os.environ</a></li><li><a href=#see-also-about-testing-in-python aria-label="See also about testing in python">See also about testing in python</a></li><li><a href=#more-about-mocking-and-testing aria-label="More about mocking and testing">More about mocking and testing</a></li></ul></div></details></div><div class=post-content><p>Let&rsquo;s consider how python standard unittest module suppose to use mocks.</p><p>Assume we want to test a method that creates and uses objects of other classes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># content of module.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># classes that we want to mock</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ClassName1</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=k>pass</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ClassName2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># class that we want to test</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter1</span><span class=p>,</span> <span class=n>parameter2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>object1</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>intermediate_result</span> <span class=o>=</span> <span class=n>object1</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>parameter1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>object2</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_result</span> <span class=o>=</span> <span class=n>object2</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>intermediate_result</span><span class=p>,</span> <span class=n>parameter2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>final_result</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></td></tr></table></div></div><p>Here is how we can test object creation (Snippet is taken from <a href=https://docs.python.org/3/library/unittest.mock.html>official documentation</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>patch</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>MockClass1</span> <span class=ow>is</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>MockClass2</span> <span class=ow>is</span> <span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>MockClass1</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>MockClass2</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>I would say that in our case we need also to check that each object (<code>object1</code> and <code>object2</code>) were instanciated and called with correct parameters. Then we can use <code>assert_called_once_with</code> like this (example from <a href=https://docs.python.org/3/library/unittest.mock.html#quick-guide>official documentation</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>ProductionClass</span><span class=p>,</span> <span class=s1>&#39;method&#39;</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_method</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>thing</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>thing</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_method</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Combining things together:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mocked_intermediate_result</span> <span class=o>=</span> <span class=s2>&#34;some-intermediate-result&#34;</span>
</span></span><span class=line><span class=cl><span class=n>mocked_final_result</span> <span class=o>=</span> <span class=s2>&#34;some-final-result&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>patch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass1</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mocked_intermediate_result</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass2</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mocked_final_result</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>actual_result</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>ProductionClass</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>actual_result</span> <span class=o>==</span> <span class=n>mocked_final_result</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass1</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass1</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass2</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>MockClass2</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=n>mocked_intermediate_result</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></td></tr></table></div></div><p>Seems good but a little bit too verbose. Assertions on calls could be eliminated. I would like to do it like in Java with <a href=http://static.javadoc.io/org.mockito/mockito-core/2.7.13/org/mockito/Mockito.html#stubbing>Mockito</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>when</span><span class=o>(</span><span class=n>mockedObject</span><span class=o>.</span><span class=na>foo</span><span class=o>(</span><span class=s>&#34;parameter&#34;</span><span class=o>)).</span><span class=na>thenReturn</span><span class=o>(</span><span class=s>&#34;mocked-result&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>That means you don&rsquo;t need to verify intermediate calls. If they fail, the consequent calls fail as well.</p><p>The test would look like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>when</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>)</span><span class=o>.</span><span class=fm>__call__</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter1&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>then_when</span><span class=p>()</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>then_return</span><span class=p>(</span><span class=n>mocked_intermediate_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>when</span><span class=p>(</span><span class=n>MockClass2</span><span class=p>)</span><span class=o>.</span><span class=fm>__call__</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter2&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>then_when</span><span class=p>()</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>mocked_intermediate_result</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>then_return</span><span class=p>(</span><span class=n>mocked_final_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=n>actual_result</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>ProductionClass</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>actual_result</span> <span class=o>==</span> <span class=n>mocked_final_result</span>    
</span></span></code></pre></td></tr></table></div></div><p>You don&rsquo;t need calls assertions in the end. If for example <code>object1.run(parameter1)</code> returns something else, then condition of the second mock object is not met and the test fails.</p><p><em>Question: is there a way to achieve that?</em></p><p>There is a port of Mockito to Python: <a href=https://github.com/kaste/mockito-python>mockito-python</a>
There you can do virtually the same as in Java:</p><pre tabindex=0><code>from mockito import when, mock, unstub

when(os.path).exists(&#39;/foo&#39;).thenReturn(True)

# or:
import requests  # the famous library
# you actually want to return a Response-like obj, we&#39;ll fake it
response = mock({&#39;status_code&#39;: 200, &#39;text&#39;: &#39;Ok&#39;})
when(requests).get(...).thenReturn(response)

# use it
requests.get(&#39;http://google.com/&#39;)

# clean up
unstub()
</code></pre><p>But:</p><ul><li><p>clean up is required</p></li><li><p>the module seems not integrating standard unittest&rsquo;s mocks . Maybe I am wrong, more investigation is required. I want to use <code>mock.patch</code> and have <code>when-thenReturn</code> construction working for it.</p></li></ul><h2 id=similar-articles>Similar articles<a hidden class=anchor aria-hidden=true href=#similar-articles>#</a></h2><ul><li><a href=https://blog.fugue.co/2016-02-11-python-mocking-101.html>Python Mocking 101: Fake It Before You Make It</a></li><li><a href=http://fgimian.github.io/blog/2014/04/10/using-the-python-mock-library-to-fake-regular-functions-during-tests/>Using the Python mock library to fake regular functions during tests</a></li></ul><h2 id=mocking-requests-in-python>Mocking requests in python<a hidden class=anchor aria-hidden=true href=#mocking-requests-in-python>#</a></h2><p>There is a library <a href=https://pypi.python.org/pypi/requests-mock>requests-mock</a> that helps testing network interactions.</p><p>Installation is easy: <code>pip install requests_mock</code>.</p><h3 id=usage-example>Usage example<a hidden class=anchor aria-hidden=true href=#usage-example>#</a></h3><p>Lets imagine you have a function <code>get_data</code> that queries an external API.
We want to check that the function throws an exception if page is not found (http code 404).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests_mock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_function_throws_an_exception_if_page_not_found</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>requests_mock</span><span class=o>.</span><span class=n>Mocker</span><span class=p>()</span> <span class=k>as</span> <span class=n>m</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=n>error_text</span><span class=p>,</span> <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>get_data</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>m.post</code> mocks requests for the predefined url and returns status_code=404 and some text message. One can also specify returned JSON data.</p><h2 id=how-to-avoid-mocking>How to avoid mocking<a hidden class=anchor aria-hidden=true href=#how-to-avoid-mocking>#</a></h2><p>Python is <s>very</s> too flexible with respect to types. Sometimes it plays agains the developers. If interface of the mocked class <code>A</code> changes you don&rsquo;t notice that tests for a dependent class <code>B</code> are failing if you mock <code>A</code> in <code>test_B</code>.</p><p>Possible way to avoid it is to pass a factory to the dependent class.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ClassName1</span><span class=p>:</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ClassName2</span><span class=p>:</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ClassFactory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>create_instance_class1</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ClassName1</span><span class=p>(</span><span class=n>parameter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>create_instance_class2</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ClassName2</span><span class=p>(</span><span class=n>parameter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1># class that we want to test</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionClassWithFactory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>factory</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>factory</span> <span class=o>=</span> <span class=n>factory</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter1</span><span class=p>,</span> <span class=n>parameter2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>object1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factory</span><span class=o>.</span><span class=n>create_instance_class1</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>intermediate_result</span> <span class=o>=</span> <span class=n>object1</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>parameter1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>object2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factory</span><span class=o>.</span><span class=n>create_instance_class2</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_result</span> <span class=o>=</span> <span class=n>object2</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>intermediate_result</span><span class=p>,</span> <span class=n>parameter2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>final_result</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s test:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj1</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj1</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;result1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj2</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj2</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;result2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_factory</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_factory</span><span class=o>.</span><span class=n>create_instance_class1</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mocked_obj1</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_factory</span><span class=o>.</span><span class=n>create_instance_class2</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mocked_obj2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual_result</span> <span class=o>=</span> <span class=n>ProductionClassWithFactory</span><span class=p>(</span><span class=n>mocked_factory</span><span class=p>)</span><span class=o>.</span><span class=n>foo</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># check final result:</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>actual_result</span> <span class=o>==</span> <span class=s2>&#34;result2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># check calls arguments</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_factory</span><span class=o>.</span><span class=n>create_instance_class1</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_factory</span><span class=o>.</span><span class=n>create_instance_class2</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;some_initial_parameter2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj1</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;parameter1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mocked_obj2</span><span class=o>.</span><span class=n>run</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s2>&#34;result1&#34;</span><span class=p>,</span> <span class=s2>&#34;parameter2&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Also you need to test the factory now. And it will require class monkey-patching. But in this case you put all monkey patching in one place.</p><h2 id=matching-attributes-for-mocks>Matching attributes for mocks<a hidden class=anchor aria-hidden=true href=#matching-attributes-for-mocks>#</a></h2><p>Keep in mind that standard mocks don&rsquo;t care about non-existent atttributes. I use</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>,</span> <span class=n>autospec</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>instead of</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;module.ClassName1&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>That adds automatic checking of non-existent attributes and catches more errors.
Let&rsquo;s see where <code>autospec=True</code> can save your life.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>foo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;foo&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>bar</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;bar&#34;</span> <span class=o>+</span> <span class=n>A</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>here comes a test:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@mock</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=s1>&#39;module.A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_bar</span><span class=p>(</span><span class=n>MockedA</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>MockedA</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;mocked-foo&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>assert</span> <span class=n>B</span><span class=p>()</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&#34;bar&#34;</span> <span class=o>+</span> <span class=s2>&#34;mocked-foo&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>At some point you decide to change class <code>A</code>. New version:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>oops</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;oops&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>You change tests for <code>A</code> but you can forget to fix <code>B</code> and tests for <code>B</code>. <code>test_bar</code> will still work because mocked <code>A</code> still have <code>foo</code>. Probably you can catch that error on integration tests level, but it is better to &ldquo;fail fast&rdquo;.</p><p>If you use <code>@mock.patch('module.A', autospec=True)</code>, then you get an error (about non-existent attribute) after you change <code>A</code> on</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>MockedA</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s2>&#34;mocked-foo&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>I think <code>autospec=True</code> has to be default behaviour of <code>patch</code>.</p><p>See also <a href=https://www.relaxdiego.com/2014/04/mocking-objects-in-python.html>Mocking Objects in Python</a> section &ldquo;Danger: mocking non-existent attributes&rdquo;</p><h2 id=alternative-mocking-libraries>Alternative mocking libraries<a hidden class=anchor aria-hidden=true href=#alternative-mocking-libraries>#</a></h2><p><a href=https://flexmock.readthedocs.io/en/latest/compare/>Flexmock</a> &ndash; extended/rebuilt clone of mocking library from Ruby. Abandoned project (last update in github in 2016).</p><p>Interesting syntax. Probably cleaner mocking sometimes. Example from docs for overriding new instances of a class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># flexmock</span>
</span></span><span class=line><span class=cl><span class=n>flexmock</span><span class=p>(</span><span class=n>some_module</span><span class=o>.</span><span class=n>SomeClass</span><span class=p>)</span><span class=o>.</span><span class=n>new_instances</span><span class=p>(</span><span class=n>some_other_object</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>assertEqual</span><span class=p>(</span><span class=n>some_other_object</span><span class=p>,</span> <span class=n>some_module</span><span class=o>.</span><span class=n>SomeClass</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># .......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Mock</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>mock</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=s1>&#39;somemodule.Someclass&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>MockClass</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>MockClass</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>some_other_object</span>
</span></span><span class=line><span class=cl>  <span class=k>assert</span> <span class=n>some_other_object</span> <span class=o>==</span> <span class=n>some_module</span><span class=o>.</span><span class=n>SomeClass</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>// Will it really work?</p><h2 id=mocking-osenviron>Mocking os.environ<a hidden class=anchor aria-hidden=true href=#mocking-osenviron>#</a></h2><pre tabindex=0><code>@mock.patch.dict(os.environ, {&#39;YOUR_VARIABLE&#39;: &#39;MOCKED_VALUE&#39;})
def test_funciton():
  function_using_os_environment()
</code></pre><h2 id=see-also-about-testing-in-python>See also about testing in python<a hidden class=anchor aria-hidden=true href=#see-also-about-testing-in-python>#</a></h2><ul><li><a href=/run-docker-as-pytest-fixture.html>Run docker as pytest fixture</a></li><li><a href=/testing-json-responses-in-Flask-REST-apps-with-pytest.html>Testing json responses in Flask REST apps with pytest</a></li><li><a href=/refactoring-python-extract-variable.html>Refactoring python code. Extracting variables and other.</a></li><li>Alex Marandon. <a href=http://alexmarandon.com/articles/python_mock_gotchas/>Python Mock Gotchas</a></li><li>José R.C. Cruz. <a href=http://www.drdobbs.com/testing/using-mocks-in-python/240168251#>Using Mocks in Python</a>. May 22, 2014</li><li><a href=https://semaphoreci.com/community/tutorials/testing-python-requests-with-betamax>https://semaphoreci.com/community/tutorials/testing-python-requests-with-betamax</a></li></ul><h2 id=more-about-mocking-and-testing>More about mocking and testing<a hidden class=anchor aria-hidden=true href=#more-about-mocking-and-testing>#</a></h2><ul><li>Martin Fowler. <a href=https://martinfowler.com/articles/mocksArentStubs.html>Mocks Aren&rsquo;t Stubs</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://serge-m.github.io/tags/python/>python</a></li><li><a href=https://serge-m.github.io/tags/testing/>testing</a></li><li><a href=https://serge-m.github.io/tags/unittests/>unittests</a></li></ul><nav class=paginav><a class=prev href=https://serge-m.github.io/posts/no-protocol-specified/><span class=title>« Prev Page</span><br><span>"No protocol specified" while running a program as another user</span></a>
<a class=next href=https://serge-m.github.io/posts/on-image-search/><span class=title>Next Page »</span><br><span>On image search</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on twitter" href="https://twitter.com/intent/tweet/?text=Mocking%20in%20Python&url=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f&hashtags=python%2ctesting%2cunittests"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f&title=Mocking%20in%20Python&summary=Mocking%20in%20Python&source=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f&title=Mocking%20in%20Python"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on whatsapp" href="https://api.whatsapp.com/send?text=Mocking%20in%20Python%20-%20https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Mocking in Python on telegram" href="https://telegram.me/share/url?text=Mocking%20in%20Python&url=https%3a%2f%2fserge-m.github.io%2fposts%2fmocking-in-python%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://serge-m.github.io/>sergem's personal public notebook</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>