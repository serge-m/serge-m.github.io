<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenVPN server in cloud using docker | sergem's personal public notebook</title><meta name=keywords content="linux,docker,vpn,openvpn"><meta name=description content="links:
How To Run OpenVPN in a Docker Container on Ubuntu 14.04 
OpenVPN for Docker
Connection via OPenVPN is slow for https Try the following advice The udp connection is perfect with these parameters (in client config):
mssfix 1200 tun-mtu 1200 DNS doesn&rsquo;t work through VPN Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping google.com)
Solution:
This is a bug that&rsquo;s fixed in upstream NetworkManager."><meta name=author content="SergeM"><link rel=canonical href=https://serge-m.github.io/posts/openvpn-on-vps-using-docker/><link href=/assets/css/stylesheet.min.6d98a2276d0cb41ef459267b3ff3ef02df70a8f16b70bbc52b20568702bc90cf.css integrity="sha256-bZiiJ20MtB70WSZ7P/PvAt9wqPFrcLvFKyBWhwK8kM8=" rel="preload stylesheet" as=style><link rel=icon href=https://serge-m.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://serge-m.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://serge-m.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://serge-m.github.io/apple-touch-icon.png><link rel=mask-icon href=https://serge-m.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.97.3"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-40853494-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="OpenVPN server in cloud using docker"><meta property="og:description" content="links:
How To Run OpenVPN in a Docker Container on Ubuntu 14.04 
OpenVPN for Docker
Connection via OPenVPN is slow for https Try the following advice The udp connection is perfect with these parameters (in client config):
mssfix 1200 tun-mtu 1200 DNS doesn&rsquo;t work through VPN Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping google.com)
Solution:
This is a bug that&rsquo;s fixed in upstream NetworkManager."><meta property="og:type" content="article"><meta property="og:url" content="https://serge-m.github.io/posts/openvpn-on-vps-using-docker/"><meta property="og:image" content="https://serge-m.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-01-07T07:10:00+00:00"><meta property="article:modified_time" content="2017-01-07T07:10:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://serge-m.github.io/papermod-cover.png"><meta name=twitter:title content="OpenVPN server in cloud using docker"><meta name=twitter:description content="links:
How To Run OpenVPN in a Docker Container on Ubuntu 14.04 
OpenVPN for Docker
Connection via OPenVPN is slow for https Try the following advice The udp connection is perfect with these parameters (in client config):
mssfix 1200 tun-mtu 1200 DNS doesn&rsquo;t work through VPN Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping google.com)
Solution:
This is a bug that&rsquo;s fixed in upstream NetworkManager."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://serge-m.github.io/posts/"},{"@type":"ListItem","position":2,"name":"OpenVPN server in cloud using docker","item":"https://serge-m.github.io/posts/openvpn-on-vps-using-docker/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenVPN server in cloud using docker","name":"OpenVPN server in cloud using docker","description":"links:\nHow To Run OpenVPN in a Docker Container on Ubuntu 14.04 \nOpenVPN for Docker\nConnection via OPenVPN is slow for https Try the following advice The udp connection is perfect with these parameters (in client config):\nmssfix 1200 tun-mtu 1200 DNS doesn\u0026rsquo;t work through VPN Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping google.com)\nSolution:\nThis is a bug that\u0026rsquo;s fixed in upstream NetworkManager.","keywords":["linux","docker","vpn","openvpn"],"articleBody":"links:\nHow To Run OpenVPN in a Docker Container on Ubuntu 14.04 \nOpenVPN for Docker\nConnection via OPenVPN is slow for https Try the following advice The udp connection is perfect with these parameters (in client config):\nmssfix 1200 tun-mtu 1200 DNS doesn’t work through VPN Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping google.com)\nSolution:\nThis is a bug that’s fixed in upstream NetworkManager. That said, the various GUI tools which write the NetworkManager config files haven’t been updated to ensure that DNS leaks are prevented when using vpn connections.\nTo prevent system dns from appearing and being used in /etc/resolv.conf when using a VPN, edit your vpn configuration (i.e. the file in /etc/NetworkManager/system-connections/) so it’s something like this:\n[ipv4] dns=; ignore-auto-dns=true method=auto dns-priority=-1 the negative dns-priority means only this dns server will be used. Then reload the config file:\nsudo nmcli c reload and toggle the vpn.\n/etc/resolv.conf should now only include the one dns ip address defined in the config file.\nVPS servers to try  https://billing.virmach.com/cart.php?gid=1 https://www.vultr.com/pricing/  OpenVPN setup (in Russian)  Руководство по установке и настройке OpenVPN – очень подробно. Комманды кратко - ниже. PPTP vs L2TP vs OpenVPN vs SSTP https://m.habrahabr.ru/post/216295/  OpenVPN setup notes Download easyrsa for ca: github\nYou can specify a directory to store generated keys using EASYRSA_PKI environment variable. $PWD/pki is used by default.\nSet up CA (certification authority) It is better to use a separate computer to host CA.\n1 2 3 4  root@a1aaf3e31e3a:/easyrsa# ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /easyrsa/pki   build-ca:\nroot@a1aaf3e31e3a:/easyrsa# ./easyrsa build-ca Generating a 2048 bit RSA private key ........................................................................................................................................................+++ .....................+++ writing new private key to '/easyrsa/pki/private/ca.key.jZ7M1ZpSAh' Enter PEM pass phrase: Verifying - Enter PEM pass phrase: ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [Easy-RSA CA]:test-ca CA creation complete and you may now import and sign cert requests. Your new CA certificate file for publishing is at: /easyrsa/pki/ca.crt Copy ca.crt.\n1 2 3 4 5 6 7 8 9  root@8bb29470d5c0:/easyrsa# ./easyrsa gen-crl Using configuration from ./openssl-easyrsa.cnf Enter pass phrase for /ca/pki/private/ca.key: Can't open /ca/pki/index.txt.attr for reading, No such file or directory 139922256114112:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:74:fopen('/ca/pki/index.txt.attr','r') 139922256114112:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:81: An updated CRL has been created. CRL file: /ca/pki/crl.pem   Copy crl.pem\nOn server We have to initialize PKI (private key infrastructure) here as well, then we create a request to CA.\nroot@df73a69e45da:/easyrsa# ./easyrsa init-pki init-pki complete; you may now create a CA or requests. Your newly created PKI dir is: /server/pki root@df73a69e45da:/easyrsa# ./easyrsa gen-req server nopass Generating a 2048 bit RSA private key .+++ ......................................+++ writing new private key to '/server/pki/private/server.key.75fVPXwcOd' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Common Name (eg: your user, host, or server name) [server]:vpn-server Keypair and certificate request completed. Your files are: req: /server/pki/reqs/server.req key: /server/pki/private/server.key Copy server.req to CA.\nOn CA Import:\nroot@8bb29470d5c0:/easyrsa# ./easyrsa import-req /ca/pki/import/server.req vpn-server The request has been successfully imported with a short name of: vpn-server You may now use this name to perform signing operations on this request. Sign vpn-server with type server:\nroot@8bb29470d5c0:/easyrsa# ./easyrsa sign-req server vpn-server You are about to sign the following certificate. Please check over the details shown below for accuracy. Note that this request has not been cryptographically verified. Please be sure it came from a trusted source or that you have verified the request checksum with the sender. Request subject, to be signed as a server certificate for 3650 days: subject= commonName = vpn-server Type the word 'yes' to continue, or any other input to abort. Confirm request details: yes Using configuration from ./openssl-easyrsa.cnf Enter pass phrase for /ca/pki/private/ca.key: Can't open /ca/pki/index.txt.attr for reading, No such file or directory 139728030523840:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:74:fopen('/ca/pki/index.txt.attr','r') 139728030523840:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:81: Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows commonName :ASN.1 12:'vpn-server' Certificate is to be certified until Apr 11 22:52:57 2028 GMT (3650 days) Write out database with 1 new entries Data Base Updated Certificate created at: /ca/pki/issued/vpn-server.crt Launcing OpenVPN server Configuration root@df73a69e45da:/easyrsa# ./easyrsa gen-dh Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time .+............................................................................................................................... ... ......................................................................................................++*++* DH parameters of size 2048 created at /server/pki/dh.pem root@df73a69e45da:/server/pki# openvpn --genkey --secret ta.key Create missing directories:\nmkdir /etc/openvpn/ccd mkdir -p /var/log/openvpn/ Create non-priviledged user openvpn:\nadduser --system --no-create-home --home /nonexistent --disabled-login --group openvpn Copy to /etc/openvpn the following files:\n  from CA:\n ca.crt crl.pem vpn-server.crt    from server:\n server.key (private key), dh.pem, ta.key    server.conf\n Sample content of server.conf for openvpn server  port 1194 proto udp dev tun user openvpn group openvpn persist-key persist-tun tls-server tls-timeout 120 # to avoid warning # WARNING: this cipher's block size is less than 128 bit (64 bit). Consider using a --cipher with a larger block size. # see also https://community.openvpn.net/openvpn/wiki/SWEET32 cipher AES-128-CBC cd /etc/openvpn/ dh dh.pem ca ca.crt cert vpn-server.crt key vpn-server.key crl-verify crl.pem tls-auth ta.key 0 server 10.15.0.0 255.255.255.0 client-config-dir ccd client-to-client topology subnet max-clients 5 push \"dhcp-option DNS 10.15.0.1\" route 10.15.0.0 255.255.255.0 comp-lzo keepalive 10 120 status /var/log/openvpn/openvpn-status.log 1 status-version 3 log-append /var/log/openvpn/openvpn-server.log verb 4 mute 20     To enable openvpn service to run all the server configurations from /etc/openvpn\n  edit /etc/default/openvpn, uncomment AUTOSTART=\"all\".\n  Reload:\n  sudo systemctl daemon-reload Launching service sudo service openvpn restart After that you have to see logs in /var/log/openvpn/\nIf it doesn’t start debug configuration with manual run:\nopenvpn /etc/openvpn/server.conf Launching client On the client we want to have a password for a key:\nroot@df73a69e45da:/easyrsa# ./easyrsa init-pki root@df73a69e45da:/easyrsa# ./easyrsa gen-req client1 Then copy request to CA, import.\n$ ./easy-rsa sign-req  client1 Signing request for a client:\n$ ./easy-rsa sign-req client client1 Copy signed certificates and other necessary files to the client.\nOpenVPN config for client dev tun proto udp remote YOUR_SERVER_ADDRESS 1194 client resolv-retry infinite cipher AES-128-CBC ca \"ca.crt\" cert \"client1.crt\" key \"client1.key\" tls-auth \"ta.key\" 1 remote-cert-tls server persist-key persist-tun comp-lzo verb 4 #status /var/log/openvpn/openvpn-status.log 1 status-version 3 #log-append /var/log/openvpn/openvpn-client.log How to revoke a certificate (deactivate a user) On CA:\n$ ./easyrsa revoke  $ ./easyrsa gen-crl Then you have to upload new crl.pem to your server and restart the server.\n","wordCount":"1158","inLanguage":"en","datePublished":"2017-01-07T07:10:00Z","dateModified":"2017-01-07T07:10:00Z","author":{"@type":"Person","name":"SergeM"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://serge-m.github.io/posts/openvpn-on-vps-using-docker/"},"publisher":{"@type":"Organization","name":"sergem's personal public notebook","logo":{"@type":"ImageObject","url":"https://serge-m.github.io/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://serge-m.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://serge-m.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://serge-m.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://serge-m.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://serge-m.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://serge-m.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://serge-m.github.io/posts/>Posts</a></div><h1 class=post-title>OpenVPN server in cloud using docker</h1><div class=post-meta>January 7, 2017&nbsp;·&nbsp;SergeM</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#connection-via-openvpn-is-slow-for-https aria-label="Connection via OPenVPN is slow for https">Connection via OPenVPN is slow for https</a></li><li><a href=#dns-doesnt-work-through-vpn aria-label="DNS doesn&amp;rsquo;t work through VPN">DNS doesn&rsquo;t work through VPN</a><ul><li><a href=#vps-servers-to-try aria-label="VPS servers to try">VPS servers to try</a></li><li><a href=#openvpn-setup-in-russian aria-label="OpenVPN setup (in Russian)">OpenVPN setup (in Russian)</a></li></ul></li><li><a href=#openvpn-setup-notes aria-label="OpenVPN setup notes">OpenVPN setup notes</a><ul><li><a href=#set-up-ca-certification-authority aria-label="Set up CA (certification authority)">Set up CA (certification authority)</a><ul><li><a href=#on-server aria-label="On server">On server</a></li><li><a href=#on-ca aria-label="On CA">On CA</a></li></ul></li><li><a href=#launcing-openvpn-server aria-label="Launcing OpenVPN server">Launcing OpenVPN server</a><ul><li><a href=#configuration aria-label=Configuration>Configuration</a></li><li><a href=#launching-service aria-label="Launching service">Launching service</a></li></ul></li><li><a href=#launching-client aria-label="Launching client">Launching client</a><ul><li><a href=#openvpn-config-for-client aria-label="OpenVPN config for client">OpenVPN config for client</a></li></ul></li></ul></li><li><a href=#how-to-revoke-a-certificate-deactivate-a-user aria-label="How to revoke a certificate (deactivate a user)">How to revoke a certificate (deactivate a user)</a></li></ul></div></details></div><div class=post-content><p>links:</p><p><a href=https://www.digitalocean.com/community/tutorials/how-to-run-openvpn-in-a-docker-container-on-ubuntu-14-04>How To Run OpenVPN in a Docker Container on Ubuntu 14.04</a></p><p><a href=https://github.com/kylemanna/docker-openvpn>OpenVPN for Docker</a></p><h2 id=connection-via-openvpn-is-slow-for-https>Connection via OPenVPN is slow for https<a hidden class=anchor aria-hidden=true href=#connection-via-openvpn-is-slow-for-https>#</a></h2><p>Try the following <a href="https://forums.openvpn.net/viewtopic.php?t=21857">advice</a>
The udp connection is perfect with these parameters (in client config):</p><pre tabindex=0><code>mssfix 1200
tun-mtu 1200
</code></pre><h2 id=dns-doesnt-work-through-vpn>DNS doesn&rsquo;t work through VPN<a hidden class=anchor aria-hidden=true href=#dns-doesnt-work-through-vpn>#</a></h2><p>Symptoms: Openvpn connects, you can ping web sites by IP address, but you cannot ping them by name (like ping <code>google.com</code>)</p><p><a href=https://bugs.launchpad.net/ubuntu/+source/openvpn/+bug/1211110>Solution</a>:</p><p>This is a bug that&rsquo;s fixed in upstream NetworkManager. That said, the various GUI tools which write the NetworkManager config files haven&rsquo;t been updated to ensure that DNS leaks are prevented when using vpn connections.</p><p>To prevent system dns from appearing and being used in <code>/etc/resolv.conf</code> when using a VPN, edit your vpn configuration (i.e. the file in /etc/NetworkManager/system-connections/<vpn name>) so it&rsquo;s something like this:</p><pre tabindex=0><code>[ipv4]
dns=&lt;vpn dns server ip address&gt;;
ignore-auto-dns=true
method=auto
dns-priority=-1
</code></pre><p>the negative dns-priority means only this dns server will be used.
Then reload the config file:</p><pre tabindex=0><code>sudo nmcli c reload &lt;vpn name&gt;
</code></pre><p>and toggle the vpn.</p><p>/etc/resolv.conf should now only include the one dns ip address defined in the config file.</p><h3 id=vps-servers-to-try>VPS servers to try<a hidden class=anchor aria-hidden=true href=#vps-servers-to-try>#</a></h3><ul><li><a href="https://billing.virmach.com/cart.php?gid=1">https://billing.virmach.com/cart.php?gid=1</a></li><li><a href=https://www.vultr.com/pricing/>https://www.vultr.com/pricing/</a></li></ul><h3 id=openvpn-setup-in-russian>OpenVPN setup (in Russian)<a hidden class=anchor aria-hidden=true href=#openvpn-setup-in-russian>#</a></h3><ul><li><a href=https://habrahabr.ru/post/233971/>Руководство по установке и настройке OpenVPN</a> &ndash; очень подробно. Комманды кратко - ниже.</li><li><a href=https://habrahabr.ru/post/191874/>PPTP vs L2TP vs OpenVPN vs SSTP</a></li><li><a href=https://m.habrahabr.ru/post/216295/>https://m.habrahabr.ru/post/216295/</a></li></ul><h2 id=openvpn-setup-notes>OpenVPN setup notes<a hidden class=anchor aria-hidden=true href=#openvpn-setup-notes>#</a></h2><p>Download easyrsa for ca:
<a href=https://github.com/OpenVPN/easy-rsa/releases>github</a></p><p>You can specify a directory to store generated keys using <code>EASYRSA_PKI</code> environment variable. <code>$PWD/pki</code> is used by default.</p><h3 id=set-up-ca-certification-authority>Set up CA (certification authority)<a hidden class=anchor aria-hidden=true href=#set-up-ca-certification-authority>#</a></h3><p>It is better to use a separate computer to host CA.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>root@a1aaf3e31e3a:/easyrsa# ./easyrsa init-pki
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>init-pki complete<span class=p>;</span> you may now create a CA or requests.
</span></span><span class=line><span class=cl>Your newly created PKI dir is: /easyrsa/pki
</span></span></code></pre></td></tr></table></div></div><p>build-ca:</p><pre tabindex=0><code>root@a1aaf3e31e3a:/easyrsa# ./easyrsa build-ca
Generating a 2048 bit RSA private key
........................................................................................................................................................+++
.....................+++
writing new private key to &#39;/easyrsa/pki/private/ca.key.jZ7M1ZpSAh&#39;
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [Easy-RSA CA]:test-ca

CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/easyrsa/pki/ca.crt
</code></pre><p>Copy <code>ca.crt</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@8bb29470d5c0:/easyrsa# ./easyrsa gen-crl
</span></span><span class=line><span class=cl>Using configuration from ./openssl-easyrsa.cnf
</span></span><span class=line><span class=cl>Enter pass phrase <span class=k>for</span> /ca/pki/private/ca.key:
</span></span><span class=line><span class=cl>Can<span class=s1>&#39;t open /ca/pki/index.txt.attr for reading, No such file or directory
</span></span></span><span class=line><span class=cl><span class=s1>139922256114112:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:74:fopen(&#39;</span>/ca/pki/index.txt.attr<span class=s1>&#39;,&#39;</span>r<span class=err>&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>139922256114112:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:81:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>An updated CRL has been created.
</span></span><span class=line><span class=cl>CRL file: /ca/pki/crl.pem
</span></span></code></pre></td></tr></table></div></div><p>Copy <code>crl.pem</code></p><h4 id=on-server>On server<a hidden class=anchor aria-hidden=true href=#on-server>#</a></h4><p>We have to initialize PKI (private key infrastructure) here as well, then we create a request to CA.</p><pre tabindex=0><code>root@df73a69e45da:/easyrsa# ./easyrsa init-pki

init-pki complete; you may now create a CA or requests.
Your newly created PKI dir is: /server/pki
</code></pre><pre tabindex=0><code>root@df73a69e45da:/easyrsa# ./easyrsa gen-req server nopass
Generating a 2048 bit RSA private key
.+++
......................................+++
writing new private key to &#39;/server/pki/private/server.key.75fVPXwcOd&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [server]:vpn-server

Keypair and certificate request completed. Your files are:
req: /server/pki/reqs/server.req
key: /server/pki/private/server.key
</code></pre><p>Copy <code>server.req</code> to CA.</p><h4 id=on-ca>On CA<a hidden class=anchor aria-hidden=true href=#on-ca>#</a></h4><p>Import:</p><pre tabindex=0><code>root@8bb29470d5c0:/easyrsa# ./easyrsa import-req /ca/pki/import/server.req vpn-server

The request has been successfully imported with a short name of: vpn-server
You may now use this name to perform signing operations on this request.
</code></pre><p>Sign <code>vpn-server</code> with type <code>server</code>:</p><pre tabindex=0><code>root@8bb29470d5c0:/easyrsa# ./easyrsa sign-req server vpn-server


You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 3650 days:

subject=
    commonName                = vpn-server


Type the word &#39;yes&#39; to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from ./openssl-easyrsa.cnf
Enter pass phrase for /ca/pki/private/ca.key:
Can&#39;t open /ca/pki/index.txt.attr for reading, No such file or directory
139728030523840:error:02001002:system library:fopen:No such file or directory:../crypto/bio/bss_file.c:74:fopen(&#39;/ca/pki/index.txt.attr&#39;,&#39;r&#39;)
139728030523840:error:2006D080:BIO routines:BIO_new_file:no such file:../crypto/bio/bss_file.c:81:
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
commonName            :ASN.1 12:&#39;vpn-server&#39;
Certificate is to be certified until Apr 11 22:52:57 2028 GMT (3650 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /ca/pki/issued/vpn-server.crt
</code></pre><h3 id=launcing-openvpn-server>Launcing OpenVPN server<a hidden class=anchor aria-hidden=true href=#launcing-openvpn-server>#</a></h3><h4 id=configuration>Configuration<a hidden class=anchor aria-hidden=true href=#configuration>#</a></h4><pre tabindex=0><code>root@df73a69e45da:/easyrsa# ./easyrsa gen-dh
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
.+...............................................................................................................................
...
......................................................................................................++*++*

DH parameters of size 2048 created at /server/pki/dh.pem
</code></pre><pre tabindex=0><code>root@df73a69e45da:/server/pki# openvpn --genkey --secret ta.key
</code></pre><p>Create missing directories:</p><pre tabindex=0><code>mkdir /etc/openvpn/ccd
mkdir -p /var/log/openvpn/
</code></pre><p>Create non-priviledged user <code>openvpn</code>:</p><pre tabindex=0><code>adduser --system --no-create-home --home /nonexistent --disabled-login --group openvpn
</code></pre><p>Copy to <code>/etc/openvpn</code> the following files:</p><ul><li><p>from CA:</p><ul><li><code>ca.crt</code></li><li><code>crl.pem</code></li><li><code>vpn-server.crt</code></li></ul></li><li><p>from server:</p><ul><li><code>server.key</code> (private key),</li><li><code>dh.pem</code>,</li><li><code>ta.key</code></li></ul></li><li><p><code>server.conf</code></p><details><summary>Sample content of server.conf for openvpn server</summary><pre>
  port 1194
  proto udp
  dev tun

  user openvpn
  group openvpn

  persist-key
  persist-tun
  tls-server
  tls-timeout 120

  # to avoid warning
  # WARNING: this cipher's block size is less than 128 bit (64 bit).  Consider using a --cipher with a larger block size.
  # see also https://community.openvpn.net/openvpn/wiki/SWEET32
  cipher AES-128-CBC  

  cd /etc/openvpn/
  dh dh.pem
  ca ca.crt
  cert vpn-server.crt
  key vpn-server.key
  crl-verify crl.pem
  tls-auth ta.key 0

  server 10.15.0.0 255.255.255.0
  client-config-dir ccd
  client-to-client
  topology subnet
  max-clients 5
  push "dhcp-option DNS 10.15.0.1"
  route 10.15.0.0 255.255.255.0
  comp-lzo
  keepalive 10 120

  status /var/log/openvpn/openvpn-status.log 1
  status-version 3
  log-append /var/log/openvpn/openvpn-server.log
  verb 4
  mute 20
  </pre></details></li></ul><p>To enable openvpn service to run all the server configurations from /etc/openvpn</p><ol><li><p>edit <code>/etc/default/openvpn</code>, uncomment <code>AUTOSTART="all"</code>.</p></li><li><p>Reload:</p></li></ol><pre tabindex=0><code>sudo systemctl daemon-reload
</code></pre><h4 id=launching-service>Launching service<a hidden class=anchor aria-hidden=true href=#launching-service>#</a></h4><pre tabindex=0><code>sudo service openvpn restart
</code></pre><p>After that you have to see logs in <code>/var/log/openvpn/</code></p><p>If it doesn&rsquo;t start debug configuration with manual run:</p><pre tabindex=0><code>openvpn /etc/openvpn/server.conf
</code></pre><h3 id=launching-client>Launching client<a hidden class=anchor aria-hidden=true href=#launching-client>#</a></h3><p>On the client we want to have a password for a key:</p><pre tabindex=0><code>root@df73a69e45da:/easyrsa# ./easyrsa init-pki
root@df73a69e45da:/easyrsa# ./easyrsa gen-req client1 
</code></pre><p>Then copy request to CA, import.</p><pre tabindex=0><code>$ ./easy-rsa sign-req &lt;path-to-client1.req&gt; client1
</code></pre><p>Signing request for a client:</p><pre tabindex=0><code>$ ./easy-rsa sign-req client client1
</code></pre><p>Copy signed certificates and other necessary files to the client.</p><h4 id=openvpn-config-for-client>OpenVPN config for client<a hidden class=anchor aria-hidden=true href=#openvpn-config-for-client>#</a></h4><pre tabindex=0><code>dev tun
proto udp
remote YOUR_SERVER_ADDRESS 1194
client
resolv-retry infinite

cipher AES-128-CBC

ca &#34;ca.crt&#34;
cert &#34;client1.crt&#34;
key &#34;client1.key&#34;
tls-auth &#34;ta.key&#34; 1

remote-cert-tls server
persist-key
persist-tun
comp-lzo
verb 4
#status /var/log/openvpn/openvpn-status.log 1
status-version 3
#log-append /var/log/openvpn/openvpn-client.log
</code></pre><h2 id=how-to-revoke-a-certificate-deactivate-a-user>How to revoke a certificate (deactivate a user)<a hidden class=anchor aria-hidden=true href=#how-to-revoke-a-certificate-deactivate-a-user>#</a></h2><p>On CA:</p><pre tabindex=0><code>$ ./easyrsa revoke &lt;client-name&gt;
$ ./easyrsa gen-crl
</code></pre><p>Then you have to upload new crl.pem to your server and restart the server.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://serge-m.github.io/tags/linux/>linux</a></li><li><a href=https://serge-m.github.io/tags/docker/>docker</a></li><li><a href=https://serge-m.github.io/tags/vpn/>vpn</a></li><li><a href=https://serge-m.github.io/tags/openvpn/>openvpn</a></li></ul><nav class=paginav><a class=prev href=https://serge-m.github.io/posts/add-service-in-linux/><span class=title>« Prev Page</span><br><span>Add service in ubuntu</span></a>
<a class=next href=https://serge-m.github.io/posts/docker-in-scaleway-vc1s-ubuntu-xenial/><span class=title>Next Page »</span><br><span>Docker in Scaleway's vc1s Ubuntu Xenial</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on twitter" href="https://twitter.com/intent/tweet/?text=OpenVPN%20server%20in%20cloud%20using%20docker&url=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f&hashtags=linux%2cdocker%2cvpn%2copenvpn"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f&title=OpenVPN%20server%20in%20cloud%20using%20docker&summary=OpenVPN%20server%20in%20cloud%20using%20docker&source=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f&title=OpenVPN%20server%20in%20cloud%20using%20docker"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on whatsapp" href="https://api.whatsapp.com/send?text=OpenVPN%20server%20in%20cloud%20using%20docker%20-%20https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OpenVPN server in cloud using docker on telegram" href="https://telegram.me/share/url?text=OpenVPN%20server%20in%20cloud%20using%20docker&url=https%3a%2f%2fserge-m.github.io%2fposts%2fopenvpn-on-vps-using-docker%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://serge-m.github.io/>sergem's personal public notebook</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>