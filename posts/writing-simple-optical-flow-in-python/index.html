<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Writing simple optical flow in python | sergem&#39;s personal public notebook</title>
<meta name="keywords" content="python, optical flow" />
<meta name="description" content="First of all we need a couple of test images:
# import numpy from StringIO import StringIO I0 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0 0.5000 0 0 0 0 1.0000 0 0 0 0 0.5000 0 0 0 0 0 0 0&#34;&#34;&#34;) ) I1 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0.5 0 0 0 0 1.0 0 0 0 0 0.5 0 0 0 0 0 0 0 0 &#34;">
<meta name="author" content="SergeM">
<link rel="canonical" href="https://serge-m.github.io/posts/writing-simple-optical-flow-in-python/" />
<link href="/assets/css/stylesheet.min.4a7c1baa41934a41353b5c02dd9ecd335d4e6b47f3fa5a187a77574ac682b8ac.css" integrity="sha256-SnwbqkGTSkE1O1wC3Z7NM11Oa0fz&#43;loYendXSsaCuKw=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://serge-m.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://serge-m.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://serge-m.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://serge-m.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://serge-m.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.82.0" />

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-40853494-2', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Writing simple optical flow in python" />
<meta property="og:description" content="First of all we need a couple of test images:
# import numpy from StringIO import StringIO I0 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0 0.5000 0 0 0 0 1.0000 0 0 0 0 0.5000 0 0 0 0 0 0 0&#34;&#34;&#34;) ) I1 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0.5 0 0 0 0 1.0 0 0 0 0 0.5 0 0 0 0 0 0 0 0 &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://serge-m.github.io/posts/writing-simple-optical-flow-in-python/" /><meta property="og:image" content="https://serge-m.github.io/papermod-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-11-30T14:46:00&#43;00:00" />
<meta property="article:modified_time" content="2014-11-30T14:46:00&#43;00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://serge-m.github.io/papermod-cover.png"/>

<meta name="twitter:title" content="Writing simple optical flow in python"/>
<meta name="twitter:description" content="First of all we need a couple of test images:
# import numpy from StringIO import StringIO I0 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0 0.5000 0 0 0 0 1.0000 0 0 0 0 0.5000 0 0 0 0 0 0 0&#34;&#34;&#34;) ) I1 = numpy.loadtxt(StringIO(&#34;&#34;&#34; 0 0 0 0 0 0 0.5 0 0 0 0 1.0 0 0 0 0 0.5 0 0 0 0 0 0 0 0 &#34;"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://serge-m.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Writing simple optical flow in python",
      "item": "https://serge-m.github.io/posts/writing-simple-optical-flow-in-python/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writing simple optical flow in python",
  "name": "Writing simple optical flow in python",
  "description": "First of all we need a couple of test images:\n# import numpy from StringIO import StringIO I0 = numpy.loadtxt(StringIO(\"\"\" 0 0 0 0 0 0 0 0.5000 0 0 0 0 1.0000 0 0 0 0 0.5000 0 0 0 0 0 0 0\"\"\") ) I1 = numpy.loadtxt(StringIO(\"\"\" 0 0 0 0 0 0 0.5 0 0 0 0 1.0 0 0 0 0 0.5 0 0 0 0 0 0 0 0 \"",
  "keywords": [
    "python", "optical flow"
  ],
  "articleBody": "First of all we need a couple of test images:\n# import numpy from StringIO import StringIO I0 = numpy.loadtxt(StringIO(\"\"\" 0 0 0 0 0 0 0 0.5000 0 0 0 0 1.0000 0 0 0 0 0.5000 0 0 0 0 0 0 0\"\"\") ) I1 = numpy.loadtxt(StringIO(\"\"\" 0 0 0 0 0 0 0.5 0 0 0 0 1.0 0 0 0 0 0.5 0 0 0 0 0 0 0 0 \"\"\") )Define initial horiozontal and vertical components of optical flow u = numpy.zeros_like(I0); v = numpy.zeros_like(I0); Lets write class for making warps. As OF usually deals only with small displacements, we need iterative estimation: estimate, shift image by found vectors, find again. class Warper: def `__init__`(self, shape, u0, v0, I0, I1, display = False): \"\"\" shape - shape of input function, u0, v0 - starting values of flow I0, I1 - images to compute flow between \"\"\" # saving dimensions self.M, self.N = shape[0], shape[1] # save initial estimation self.u, self.v = u0.copy(), v0.copy() # grid of coordinates, required further self.idx, self.idy = np.meshgrid(np.arange(self.N), np.arange(self.M)) # filter for partial derivatives computation self.mask = np.array([1, -8, 0, 8, -1], ndmin=2)/12.0; # flag of debug information output self.display = display self.counter = 0 # copy of images self.I0, self.I1 = I0.copy(), I1.copy() # here we create an instance of training function. On each step we will approach to minimum by gradient descent self.train = TrainFunctionSimple(u0, v0, rate=0.1) # main function def warp(self): if self.display: print 'Warp %d' % (self.counter,) # initial value u0, v0 = self.u.copy(), self.v.copy() # Ends of motion vectors. From these points we will \"compensate\" motion idxx = self.idx + u0 idyy = self.idy + v0 # get linearly interpolated values from (idxx, idyy) pixels of I1 I1warped = interp2linear(self.I1, idxx, idyy) # just debug output if self.display: print \"I1warped\", I1warped print \"I0\", I0 print \"u0\", u0 print \"v0\", v0 pass It = (I1warped - self.I0) print \"It\", It #My first wrong version (it gives no converging, something like continuing initial vectors to infinity during warps) (***) #Ix = ndimage.correlate(self.I1, self.mask, mode='nearest') #Iy = ndimage.correlate(self.I1, self.mask.T, mode='nearest') #Much better is: Ix = ndimage.correlate(I1warped, self.mask, mode='nearest') Iy = ndimage.correlate(I1warped, self.mask.T, mode='nearest') # boundary handling m = (idxx  self.N - 1) | (idxx self.M - 1) | (idyy Now describing TrainFunction. Well design is not good yet # class TrainFunction(object): def `__init__`(self, u0, v0, rate): self.rate = rate self.tu = theano.shared(u0,name='tu') self.tv = theano.shared(v0,name='tv') self.tIx = T.matrix(\"tIx\") self.tIy = T.matrix(\"tIy\") self.tIt = T.matrix(\"tIt\") self.gu, self.gv = None, None self.E = None self.train_function = self.get_function() # this function must be overloaded in the derived classes def get_energy(self): raise Exception(\"Non implemented\") # construct Theano-function for gradient descent def get_function(self): if self.E is None: self.E = self.get_energy() if self.gu is None or self.gv is None: self.gu, self.gv = T.grad(self.E, [self.tu, self.tv]) train_function = theano.function( inputs=[self.tIx, self.tIy, self.tIt], outputs=[self.E], updates=((self.tu, self.tu - self.rate * self.gu), (self.tv, self.tv - self.rate * self.gv)), allow_input_downcast=True) return train_function # initialization of flow values def init(self, u0, v0): self.tu.set_value(u0) self.tv.set_value(v0) # launching step of gradiennt descent def step(self, *args): return self.train_function(*args) # class TrainFunctionSimple(TrainFunction): def __init__(self, *args, **kwargs): self.alpha = kwargs.get(‘alpha’, 1.1)\n super(self.`__class__`, self).`__init__`(*args, **kwargs) # constructs Theano-function, that calculate Energy def get_energy(self,): # data term Edata = T.sum( ( self.tIx * self.tu + self.tIy * self.tv + self.tIt ) ** 2 ) # regularization term Ereg = T.sum( (self.tu)**2 + (self.tv)**2 ) return Edata+self.alpha*Ereg  finally launching\nwrpr = Warper( I0.shape, numpy.zeros_like(I0), numpy.zeros_like(I0), I0, I1, display=True) warps = 5 for i in range(warps): wrpr.warp() Printing the results: numpy.set_printoptions(precision=3,) print wrpr.u print wrpr.v [[ 0. 0. 0. 0. 0. ] [ 0. 0. -0.523 0. 0. ] [ 0. 0. -0.941 0. 0. ] [ 0. 0. -0.523 0. 0. ] [ 0. 0. 0. 0. 0. ]] [[ 0. 0. 0. 0. 0. ] [ 0. -0.692 0. 0. 0. ] [ 0. 0. 0. 0. 0. ] [ 0. 0.692 0. 0. 0. ] [ 0. 0. 0. 0. 0. ]] Well, not precise enough. However the direction is right.\n UPDATE: due to my error in (***), see code, results and images below may have no sense   Some errors  In this implementation we estimate how to move I1 to match I0. So vectors points from locations of I0 to points of I1. So spatial derivatives must be calculated from I1, not I0: Ix = ndimage.correlate(self.I1, self.mask, mode='nearest') Iy = ndimage.correlate(self.I1, self.mask.T, mode='nearest') If you write instead: Ix = ndimage.correlate(self.I0, self.mask, mode='nearest') Iy = ndimage.correlate(self.I0, self.mask.T, mode='nearest') you will get pressy strange results. Input images I0 and I1: ![](http://3.bp.blogspot.com/-dYfZ9eUjqE4/VHtGMwxyuQI/AAAAAAAACFg/vBjZqQkILaY/s1600/I0.png) ![](http://4.bp.blogspot.com/-G4C3gKG5W_0/VHtGMyVkRtI/AAAAAAAACFk/d51MYVnFvjo/s1600/I1.png)  So the “object” moves from left to right. I0 is a current frame and I1 is a previous frame. The vectors after 1 and 10 warps of correct iteration (derivatives of I1, I0 at background):\n![](http://2.bp.blogspot.com/-RBt_zV-BwPE/VHtGBocIBhI/AAAAAAAACFY/3bTptWcs4zc/s1600/after%2B100%2Bcorrect%2Bwarp.png) ![](http://2.bp.blogspot.com/-UdPZ2hZ7Qaw/VHtGBmkLbAI/AAAAAAAACFE/U3Wg3lnIhV0/s1600/after%2Bone%2Bcorrect%2Bwarp.png)  The vectors after 1 and 10 warps of incorrect iteration (derivatives of I0, I0 at background): ![](http://1.bp.blogspot.com/-RGrBP9xedI0/VHtGB276WkI/AAAAAAAACFI/uvpw4JUI0Xo/s1600/after%2Bone%2Bincorrect%2Bwarp.png) ![](http://1.bp.blogspot.com/-N7Piixu8HBw/VHtGBgcTDSI/AAAAAAAACFA/bgQJqZQUsvY/s1600/after%2B100%2Bincorrect%2Bwarp.png) These pictures are made with 120 steps of gradient descent. Regularization termOk. Now lets improve our regularization term. Instead of L2 norm, lets use Total Variation approach.On the same settings lets use another train function class:class TrainFunctionTV(TrainFunction): def `__init__`(self, *args, **kwargs): self.alpha = kwargs.get('alpha', 1.1)  super(self.`__class__`, self).`__init__`(*args, **kwargs) def get_energy(self,): Edata = T.sum((self.tIx * self.tu + self.tIy * self.tv + self.tIt) ** 2) Ereg1 = T.sum( (self.tu[1:]-self.tu[:-1])**2 + (self.tv[1:]-self.tv[:-1])**2 ) Ereg2 = T.sum( (self.tu[:,1:]-self.tu[:,:-1]) **2 + (self.tv[:,1:]-self.tv[:,:-1]) ** 2) return Edata+self.alpha*(Ereg1+Ereg2)  \nNow we have these results: print wrpr.u print wrpr.v [[-0.862 -0.903 -0.949 -0.941 -0.929] [-0.842 -0.92 -1.025 -0.968 -0.941] [-0.81 -0.933 -1.101 -0.99 -0.95 ] [-0.842 -0.92 -1.025 -0.968 -0.941] [-0.862 -0.903 -0.949 -0.941 -0.929]] [[-0.121 -0.136 -0.093 -0.06 -0.045] [-0.106 -0.197 -0.083 -0.043 -0.029] [-0. -0. -0. -0. -0. ] [ 0.106 0.197 0.083 0.043 0.029] [ 0.121 0.136 0.093 0.06 0.045]]\nVisualization:\n  ![](http://2.bp.blogspot.com/-RBt_zV-BwPE/VHtGBocIBhI/AAAAAAAACFc/reFzmPZUpes/s1600/after%2B100%2Bcorrect%2Bwarp.png)   ![](http://4.bp.blogspot.com/-fQ1nRz2R0TA/VI9SvoUd3iI/AAAAAAAACGU/IaqihseanNY/s1600/OF%2Bwith%2BTV.png) before (L2)after (TV) ",
  "wordCount" : "969",
  "inLanguage": "en",
  "datePublished": "2014-11-30T14:46:00Z",
  "dateModified": "2014-11-30T14:46:00Z",
  "author":{
    "@type": "Person",
    "name": "SergeM"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://serge-m.github.io/posts/writing-simple-optical-flow-in-python/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "sergem's personal public notebook",
    "logo": {
      "@type": "ImageObject",
      "url": "https://serge-m.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://serge-m.github.io/" accesskey="h" title="Home (Alt + H)">Home</a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://serge-m.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://serge-m.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://serge-m.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://serge-m.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://serge-m.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://serge-m.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Writing simple optical flow in python
    </h1>
    <div class="post-meta">November 30, 2014&nbsp;·&nbsp;SergeM
</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <div class="details">Table of Contents</div>
        </summary>
        <div class="inner"><ul>
                <li>
                    <a href="#" aria-label=" UPDATE: due to my error in (***), see code, results and images below may have no sense "> UPDATE: due to my error in (***), see code, results and images below may have no sense </a></li>
                <li>
                    <a href="#" aria-label=" Some errors "> Some errors </a><ul>
                        
                <li>
                    <a href="#" aria-label="Regularization term">Regularization term</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>First of all we need a couple of test images:</p>
<pre class="brush: python">#
import numpy
from StringIO import StringIO

I0 = numpy.loadtxt(StringIO("""
         0         0         0         0         0
         0         0    0.5000         0         0
         0         0    1.0000         0         0
         0         0    0.5000         0         0
         0         0         0         0         0""") )


I1 = numpy.loadtxt(StringIO("""
         0         0         0         0         0
         0       0.5         0         0           0
         0       1.0         0         0           0
         0       0.5         0         0           0
         0         0         0         0         0 """) )</pre>Define initial horiozontal and vertical components of optical flow 
<pre class="brush: python">u = numpy.zeros_like(I0); 
v = numpy.zeros_like(I0); 
</pre>Lets write class for making warps. As OF usually deals only with small displacements, we need iterative estimation: estimate, shift image by found vectors, find again.
<pre class="brush: python">class Warper:
    def `__init__`(self, shape, u0, v0, I0, I1, display = False):
        """
            shape - shape of input function,
            u0, v0 - starting values of flow
            I0, I1 - images to compute flow between
            
        """
        # saving dimensions
        self.M, self.N = shape[0], shape[1]
        # save initial estimation
        self.u, self.v = u0.copy(), v0.copy()
        # grid of coordinates, required further
        self.idx, self.idy = np.meshgrid(np.arange(self.N), np.arange(self.M))
        # filter for partial derivatives computation
        self.mask = np.array([1, -8, 0, 8, -1], ndmin=2)/12.0; 
        # flag of debug information output
        self.display = display
        self.counter = 0
        # copy of images
        self.I0, self.I1 = I0.copy(), I1.copy()
        
        # here we create an instance of training function. On each step we will approach to minimum by gradient descent
        self.train = TrainFunctionSimple(u0, v0, rate=0.1)
        
    # main function
    def warp(self):
        if self.display:
            print 'Warp %d' % (self.counter,)
        
        # initial value 
        u0, v0 = self.u.copy(), self.v.copy()
        
        # Ends of motion vectors. From these points we will "compensate" motion
        idxx = self.idx + u0
        idyy = self.idy + v0
        
        # get linearly interpolated values from (idxx, idyy) pixels of I1
        I1warped = interp2linear(self.I1, idxx, idyy)

        # just debug output
        if self.display:
            print "I1warped", I1warped

            print "I0", I0
            print "u0", u0
            print "v0", v0
            
            pass

        It = (I1warped - self.I0)
        print "It", It

        #My first wrong version (it gives no converging, something like continuing initial vectors to infinity during warps) (***)
        #Ix = ndimage.correlate(self.I1, self.mask, mode='nearest') 
        #Iy = ndimage.correlate(self.I1, self.mask.T, mode='nearest') 

        #Much better is:
        Ix = ndimage.correlate(I1warped, self.mask, mode='nearest') 
        Iy = ndimage.correlate(I1warped, self.mask.T, mode='nearest') 

        # boundary handling
        m = (idxx > self.N - 1) | (idxx < 0) | (idyy > self.M - 1) | (idyy < 0)
        Ix[m] = 0.0
        Iy[m] = 0.0
        It[m] = 0.0
        
        self.Ix = Ix
        self.Iy = Iy
        self.It = It
        
        self.train.init(np.zeros_like(self.I0), np.zeros_like(self.I0))
        for i_sgd in range(120):
            print self.train.step(Ix, Iy, It),

        self.u += self.train.tu.get_value()
        self.v += self.train.tv.get_value()
        self.counter += 1
</pre>Now describing TrainFunction. Well design is not good yet 
<pre class="brush: python">#
class TrainFunction(object):
    def `__init__`(self, u0, v0, rate):
        self.rate = rate
        self.tu = theano.shared(u0,name='tu')
        self.tv = theano.shared(v0,name='tv')
        self.tIx = T.matrix("tIx")
        self.tIy = T.matrix("tIy")
        self.tIt = T.matrix("tIt")
        
        self.gu, self.gv = None, None
        self.E = None
        self.train_function = self.get_function()
        
    # this function must be overloaded in the derived classes
    def get_energy(self):
        raise Exception("Non implemented")
            
    # construct Theano-function for gradient descent 
    def get_function(self):
        if self.E is None:
            self.E = self.get_energy()
        
        if self.gu is None or self.gv is None:
            self.gu, self.gv = T.grad(self.E, [self.tu, self.tv])  
            
        train_function = theano.function(
            inputs=[self.tIx, self.tIy, self.tIt],
            outputs=[self.E],
            updates=((self.tu, self.tu - self.rate * self.gu), (self.tv, self.tv - self.rate * self.gv)),
            allow_input_downcast=True)
    
        return train_function
    
    # initialization of flow values
    def init(self, u0, v0):
        self.tu.set_value(u0)
        self.tv.set_value(v0)
        
    # launching step of gradiennt descent
    def step(self, *args):
        return self.train_function(*args)
</pre><pre class="brush: python">#
<p>class TrainFunctionSimple(TrainFunction):
def <code>__init__</code>(self, *args, **kwargs):
self.alpha = kwargs.get(&lsquo;alpha&rsquo;, 1.1)</p>
<pre><code>    super(self.`__class__`, self).`__init__`(*args, **kwargs)
    
# constructs Theano-function, that calculate Energy
def get_energy(self,):
    # data term 
    Edata = T.sum( ( self.tIx * self.tu + self.tIy * self.tv + self.tIt ) ** 2 ) 

    # regularization term
    Ereg = T.sum(
        (self.tu)**2 + 
        (self.tv)**2 )

    return Edata+self.alpha*Ereg
</code></pre>
<p></pre>finally launching</p>
<pre class="brush: python">wrpr = Warper( I0.shape, numpy.zeros_like(I0), numpy.zeros_like(I0), I0, I1, display=True)
warps = 5
for i in range(warps):
    wrpr.warp()
</pre>Printing the results: 
<pre class="brush: python">numpy.set_printoptions(precision=3,)

print wrpr.u
print wrpr.v
</pre><pre class="brush: python">[[ 0.     0.     0.     0.     0.   ]
<p>[ 0.     0.    -0.523  0.     0.   ]
[ 0.     0.    -0.941  0.     0.   ]
[ 0.     0.    -0.523  0.     0.   ]
[ 0.     0.     0.     0.     0.   ]]
[[ 0.     0.     0.     0.     0.   ]
[ 0.    -0.692  0.     0.     0.   ]
[ 0.     0.     0.     0.     0.   ]
[ 0.     0.692  0.     0.     0.   ]
[ 0.     0.     0.     0.     0.   ]]
</pre>Well, not precise enough. However the direction is right.</p>
<h1> UPDATE: due to my error in (***), see code, results and images below may have no sense </h1>    <h1> Some errors </h1>  In this implementation we estimate how to move I1 to match I0. So vectors points from locations of I0 to points of I1. So spatial derivatives must be calculated from I1, not I0: 
<pre class="brush: python">Ix = ndimage.correlate(self.I1, self.mask, mode='nearest') 
Iy = ndimage.correlate(self.I1, self.mask.T, mode='nearest') 
</pre>If you write instead: 
<pre class="brush: python">Ix = ndimage.correlate(self.I0, self.mask, mode='nearest') 
Iy = ndimage.correlate(self.I0, self.mask.T, mode='nearest') 
</pre>you will get pressy strange results.
Input images I0 and I1:
</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;">
![](http://3.bp.blogspot.com/-dYfZ9eUjqE4/VHtGMwxyuQI/AAAAAAAACFg/vBjZqQkILaY/s1600/I0.png)
</td><td style="text-align: center;">
![](http://4.bp.blogspot.com/-G4C3gKG5W_0/VHtGMyVkRtI/AAAAAAAACFk/d51MYVnFvjo/s1600/I1.png)
</td></tr></tbody></table>
<p>So the &ldquo;object&rdquo; moves from left to right. I0 is a current frame and I1 is a previous frame. The vectors after 1 and 10 warps of correct iteration (derivatives of I1, I0 at background):</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;">
![](http://2.bp.blogspot.com/-RBt_zV-BwPE/VHtGBocIBhI/AAAAAAAACFY/3bTptWcs4zc/s1600/after%2B100%2Bcorrect%2Bwarp.png)
</td><td style="text-align: center;">
![](http://2.bp.blogspot.com/-UdPZ2hZ7Qaw/VHtGBmkLbAI/AAAAAAAACFE/U3Wg3lnIhV0/s1600/after%2Bone%2Bcorrect%2Bwarp.png)
</td></tr></tbody></table>
<div style="text-align: left;">The vectors after 1 and 10 warps of incorrect iteration (derivatives of I0, I0 at background): </div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;">
![](http://1.bp.blogspot.com/-RGrBP9xedI0/VHtGB276WkI/AAAAAAAACFI/uvpw4JUI0Xo/s1600/after%2Bone%2Bincorrect%2Bwarp.png)
</td><td style="text-align: center;">
![](http://1.bp.blogspot.com/-N7Piixu8HBw/VHtGBgcTDSI/AAAAAAAACFA/bgQJqZQUsvY/s1600/after%2B100%2Bincorrect%2Bwarp.png)
 </td></tr></tbody></table><pre class="brush: python"></pre><pre class="brush: python"></pre><pre class="brush: python"></pre><pre class="brush: python"></pre>These pictures are made with 120 steps of gradient descent.
<h2 style="text-align: left;">Regularization term</h2><div style="text-align: left;">Ok. Now lets improve our regularization term. Instead of L2 norm, lets use Total Variation approach.</div><div style="text-align: left;">On the same settings&nbsp; lets use another train function class:</div><div style="text-align: left;"><pre class="brush: python">class TrainFunctionTV(TrainFunction):
    def `__init__`(self, *args, **kwargs):
        self.alpha = kwargs.get('alpha', 1.1)
<pre><code>    super(self.`__class__`, self).`__init__`(*args, **kwargs)

def get_energy(self,):
    Edata = T.sum((self.tIx * self.tu + self.tIy * self.tv + self.tIt) ** 2)
    Ereg1 = T.sum(
        (self.tu[1:]-self.tu[:-1])**2 +
        (self.tv[1:]-self.tv[:-1])**2 )
    Ereg2 = T.sum(
        (self.tu[:,1:]-self.tu[:,:-1]) **2 +
        (self.tv[:,1:]-self.tv[:,:-1]) ** 2)

    return Edata+self.alpha*(Ereg1+Ereg2)   
</code></pre>
<p></pre></p>
</div><div style="text-align: left;">Now we have these results:
<pre class="brush: python">print wrpr.u
print wrpr.v
<p>[[-0.862 -0.903 -0.949 -0.941 -0.929]
[-0.842 -0.92  -1.025 -0.968 -0.941]
[-0.81  -0.933 -1.101 -0.99  -0.95 ]
[-0.842 -0.92  -1.025 -0.968 -0.941]
[-0.862 -0.903 -0.949 -0.941 -0.929]]
[[-0.121 -0.136 -0.093 -0.06  -0.045]
[-0.106 -0.197 -0.083 -0.043 -0.029]
[-0.    -0.    -0.    -0.    -0.   ]
[ 0.106  0.197  0.083  0.043  0.029]
[ 0.121  0.136  0.093  0.06   0.045]]</p>
<p></pre>Visualization:</p>
<table><tbody><tr>  <td>
![](http://2.bp.blogspot.com/-RBt_zV-BwPE/VHtGBocIBhI/AAAAAAAACFc/reFzmPZUpes/s1600/after%2B100%2Bcorrect%2Bwarp.png)
</td> <td>
![](http://4.bp.blogspot.com/-fQ1nRz2R0TA/VI9SvoUd3iI/AAAAAAAACGU/IaqihseanNY/s1600/OF%2Bwith%2BTV.png)
</td></tr><tr><td style="text-align: center;">before (L2)</td><td style="text-align: center;">after (TV)</td></tr></tbody></table></div>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://serge-m.github.io/tags/python/">python</a></li>
      <li><a href="https://serge-m.github.io/tags/optical-flow/">optical flow</a></li>
    </ul>
    <nav class="paginav">
      <a class="prev" href="https://serge-m.github.io/posts/writing-simple-optical-flow-in-python-part2/">
        <span class="title">« Prev Page</span>
        <br>
        <span>Writing simple optical flow in python. Part 2</span>
      </a>
      <a class="next" href="https://serge-m.github.io/posts/setting-default-parameters-from-imshow/">
        <span class="title">Next Page »</span>
        <br>
        <span>Setting default parameters for imshow in pyplot</span>
      </a>
    </nav>
<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on twitter"
        href="https://twitter.com/intent/tweet/?text=Writing%20simple%20optical%20flow%20in%20python&amp;url=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f&amp;hashtags=python%2copticalflow">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f&amp;title=Writing%20simple%20optical%20flow%20in%20python&amp;summary=Writing%20simple%20optical%20flow%20in%20python&amp;source=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f&title=Writing%20simple%20optical%20flow%20in%20python">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on whatsapp"
        href="https://api.whatsapp.com/send?text=Writing%20simple%20optical%20flow%20in%20python%20-%20https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Writing simple optical flow in python on telegram"
        href="https://telegram.me/share/url?text=Writing%20simple%20optical%20flow%20in%20python&amp;url=https%3a%2f%2fserge-m.github.io%2fposts%2fwriting-simple-optical-flow-in-python%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    <footer class="footer">
    <span>&copy; 2021 <a href="https://serge-m.github.io/">sergem&#39;s personal public notebook</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>
<script defer src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>

<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>
